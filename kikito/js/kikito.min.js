var KK=KK||{};KK.Utils=function(){this.Iterator=function(arr,isCircular){var _index=0;var _data=arr||[];var _len=arr.length;return{next:function(){if(!this.hasNext()){if(isCircular){_index=0}else{return}}return _data[_index++]},hasNext:function(){return _index<_len},current:function(){return _data[_index]}}};var _removeSpacesFromString=function(str){return str.replace(/[^A-Z0-9]/gi,"")||""};var _isUrl=function(str){return new RegExp("^(http[s]?:\\/\\/(www\\.)?|ftp:\\/\\/(www\\.)?|www\\.){1}([0-9A-Za-z-\\.@:%_+~#=]+)+((\\.[a-zA-Z]{2,3})+)(/(.)*)?(\\?(.)*)?").test(str)?true:false};return{Iterator:this.Iterator,removeSpacesFromString:_removeSpacesFromString,isUrl:_isUrl}}();var KK=KK||{};KK.UiComponents=function(){this.HorizontalList=function(param){var _MAX_PRELOAD_PERC=param.maxPreload||20;var _frag=document.createDocumentFragment();var _div=document.createElement("div");var _container=_div.cloneNode(false);_container.id=KK.Utils.removeSpacesFromString(param.category)||"";_frag.appendChild(_container);var _txtCategory=_div.cloneNode(false);_txtCategory.className="txt-category";_txtCategory.innerText=param.category||"";_container.appendChild(_txtCategory);var _size=0;if(typeof param.moviesList!=="undefined"&&param.moviesList.constructor===Array){_size=param.moviesList.length}var _hList=_div.cloneNode(false);_hList.className="h-list";for(var i=0;i<_size;i++){var _ele=_div.cloneNode(false);_ele.className="h-ele";var _pic=param.getMoviePic(param.moviesList[i]);_ele.id=param.moviesList[i];var MIN=10;if(i<MIN||i/_size*100<_MAX_PRELOAD_PERC){_ele.style.background="url('"+_pic+"')"}_ele.style.backgroundColor="black";_ele.style.backgroundSize="125px 180px";_ele.style.backgroundRepeat="no-repeat";_ele.title="url('"+_pic+"')";_hList.appendChild(_ele)}_container.appendChild(_hList);this.getFragment=function(){return _frag};this.renderNext=function(perc){}};this.VerticalInfiniteList=function(param){var _index=0;var _data=param.data||[];var _len=param.data.length;var _PAGE_SIZE=param.pageSize||5;var _className=param.className;var _targetEle=param.targetEle;var _MAX_NODES=param.maxNodes||100;var _list=_targetEle.getElementsByClassName(_className);var _ite;var _checkSizeMemoryManagement=function(callback){var i=0;var eleList=_targetEle.getElementsByClassName(_className);console.log("Nro divs:"+eleList.length);if(eleList.length>=_MAX_NODES){while(_targetEle.firstElementChild){i++;if(i>=_MAX_NODES/2)break;if(typeof callback==="function")callback(_targetEle.firstElementChild.lastElementChild);_targetEle.removeChild(_targetEle.firstElementChild);window.scrollTo(pageXOffset,pageYOffset-_targetEle.firstElementChild.offsetHeight);console.log("Cleaning up, adjusting scrolling...")}}};var _page=0;this.renderNextPage=function(list,callback){if(typeof _ite==="undefined")this.updateList(list);for(var i=0;i<_PAGE_SIZE;i++){_targetEle.appendChild(list[_ite.next()].cloneNode(true))}_page++;if(_page%5===0){_checkSizeMemoryManagement(callback)}};this.updateList=function(list){_list=list||_list||{};_ite=new KK.Utils.Iterator(Object.keys(_list),true)};return{updateList:this.updateList,renderNextPage:this.renderNextPage}};return{VerticalInfiniteList:this.VerticalInfiniteList,HorizontalList:this.HorizontalList}}();var KK=KK||{};KK.Model=function(){var _movieLists=[];var _movieHash={};this.init=function(param){if(typeof param==="undefined")return;if(typeof param.dataObj!=="undefined"){_initModelFromObj(param.dataObj,param.callback)}else if(typeof param.remoteDataUrl!=="undefined"){_initModelFromRemote(param.remoteDataUrl,param.callback)}else if(typeof param.localDataPath!=="undefined"){_initModelFromLocalData(param.localDataPath,param.callback)}};var _initModelFromObj=function(data,callback){if(typeof data.lists!=="undefined"&&data.lists.constructor===Array&&data.lists.length>0){_movieLists=data.lists}if(typeof data.movies!=="undefined"&&data.movies.constructor===Object){_movieHash=data.movies}if(typeof callback==="function")callback()};var _initModelFromRemote=function(url,callback){var _xhr=new XMLHttpRequest;_xhr.open("get",url,true);_xhr.onreadystatechange=function(){var _status;var _data;if(_xhr.readyState===4&&_xhr.status===200){_data=JSON.parse(xhr.responseText);if(typeof callback==="function")callback(_data)}else{}};_xhr.send()};var _initModelFromLocalData=function(url,callback){};this.getCountLists=function(){return _movieLists.length};this.getCount=function(){var count=0;for(var key in _movieHash){count++}return count};this.getMovieSummary=function(id){return _movieHash[id]||{}};Object.prototype.ig=function(){if(typeof this==="undefined")return false;else return true};this.getMovieTitle=function(id){return _movieHash[id].summary.title.title_short};this.toString=function(){console.log(_movieLists)};this.getNextList=function(){if(typeof this.ite==="undefined"){this.ite=new KK.Utils.Iterator(_movieLists)}var nxt=this.ite.next();var ret={moviesList:[],category:""};if(typeof nxt!=="undefined"&&typeof nxt.movies!=="undefined"&&nxt.movies.constructor===Array){ret.moviesList=nxt.movies}if(typeof nxt!=="undefined"&&typeof nxt.summary!=="undefined"&&typeof nxt.summary.displayName!=="undefined"){ret.category=nxt.summary.displayName}return ret};this.getCoverPic=function(param){if(typeof param.id==="undefined")return;var ele=_movieHash[param.id];if(typeof ele.summary!=="undefined"&&typeof ele.summary.box_art!=="undefined"){switch(param.size){case"portrait-small":var url=ele.summary.box_art["150x214"];break;case"portrait-medium":var url=ele.summary.box_art["284x405"];break;case"landscape-small":var url=ele.summary.box_art["350x197"];break;case"landscape-medium":var url=ele.summary.box_art["665x375"];break}}return typeof url!=="undefined"&&KK.Utils.isUrl(url)?url:undefined};this.hasNextList=function(){if(typeof this.ite==="undefined"){this.ite=new KK.Utils.Iterator(_movieLists)}return this.ite.hasNext()}};var KK=KK||{};KK.Controller=function(model,view){var _model=model;var _view=view;var _dView;var _scrollOffset;var _listSelectedElements=[];var _listOfHorizontalLists={};this.init=function(){_initEvents();_model.init({dataObj:mockResponse,remoteDataUrl:"",localDataPath:"",callback:_populateMainView})};var _populateMainView=function(){while(_model.hasNextList()){var _list=_model.getNextList();if(_list.category===""||typeof _listOfHorizontalLists[KK.Utils.removeSpacesFromString(_list.category)]!=="undefined"){continue}var hl=view.addHorizonalList({moviesList:_list.moviesList,category:_list.category,getMoviePic:_getPicFromModel});_listOfHorizontalLists[KK.Utils.removeSpacesFromString(_list.category)]=hl.getFragment()}_view.createVerticalInfiniteList(_listOfHorizontalLists);_view.render(_listOfHorizontalLists)};var _initEvents=function(){window.addEventListener("DOMContentLoaded",function(){_addVerticalScrollingEventListener();_addEventListenerToAllHorizontalLists();_addEventListenerToUnselectAll()});window.addEventListener("load",function(){document.getElementById("loadingScreen").style.display="none"})};var _addEventListenerToUnselectAll=function(){window.addEventListener("click",_handleUnselectAll)};var _handleUnselectAll=function(e){if(typeof e.target!=="undefined"&&e.target.className.indexOf("h-ele")>=0)return;for(var i=0;i<_listSelectedElements.length;i++){_view.unselectElement(_listSelectedElements[i])}_listSelectedElements=[]};var _addVerticalScrollingEventListener=function(){window.addEventListener("scroll",_handleVerticalScrolling)};var _removeVerticalScrollingEventListener=function(){window.removeEventListener("scroll",_handleVerticalScrolling)};var _handleVerticalScrolling=function(){var PERC_TO_LOAD_MORE=80;var max=document.body.scrollHeight-innerHeight;var percent=pageYOffset/max*100;if(percent>PERC_TO_LOAD_MORE){_loadMore();console.log("Loading more...")}};var tapAndHoldInProgress=false;var _addEventListenerToAllHorizontalLists=function(e){var list=document.getElementsByClassName("h-list");for(var i=0;i<list.length;i++){list[i].addEventListener("scroll",_handleHorizontalScroll);var timer;list[i].addEventListener("mousedown",function(e){if(typeof e.target==="undefined"||e.target.className!=="h-ele")return;timer=setTimeout(function(){tapAndHoldInProgress=true;_handleTapAndHold(e)},500)});list[i].addEventListener("mouseup",function(e){clearTimeout(timer);setTimeout(function(){tapAndHoldInProgress=false},200)});list[i].addEventListener("click",function(e){if(!tapAndHoldInProgress){_handleClickHorizontalList(e)}})}};var _handleTapAndHold=function(e){var _target=e.target;if(typeof _target!=="undefined"&&_target.className==="h-ele"){_view.selectElement(_target);_listSelectedElements.push(_target);e.stopPropagation()}};var _handleClickHorizontalList=function(e){var _target=e.target;if(typeof _target!=="undefined"&&_target.className==="h-ele"){var _title=_model.getMovieTitle(_target.id);var _pic=_getPicFromModel(_target.id);console.log("Offset:"+_target.offsetTop);_scrollOffset=_target.offsetParent.scrollTop;_createMovieDetailsView({title:_title,pic:_pic});e.stopPropagation()}};var _handleHorizontalScroll=function(e){var PERC_TO_LOAD_MORE=20;var max=parseInt(e.srcElement.scrollWidth)-e.srcElement.clientWidth;var x=e.srcElement.scrollLeft;var perc=x/max*100;console.log("scrolling... "+Math.floor(perc)+"%");if(perc>PERC_TO_LOAD_MORE){console.log("loading all images for "+e.srcElement.parentElement.id);_view.loadAllImages(e.srcElement.parentElement,_removeHorizontalScrollListener)}};var _removeHorizontalScrollListener=function(ele){ele.removeEventListener("scroll",_handleHorizontalScroll)};var _addCloseBtnListener=function(){var ele=document.getElementsByClassName("btn-close");if(ele.ig()&&ele[0].ig()){ele[0].addEventListener("click",_handleClose)}};var _handleClose=function(e){window.scrollTo(pageXOffset,_scrollOffset);_dView.hide();_addVerticalScrollingEventListener();e.stopPropagation()};var _createMovieDetailsView=function(param){_dView=_dView||new KK.ViewMovieDetails;_dView.render({callback:_rendered,title:param.title,pic:param.pic});_removeVerticalScrollingEventListener()};var _rendered=function(){_addCloseBtnListener()};var _getPicFromModel=function(id){return _model.getCoverPic({id:id,size:"portrait-small"})};var _loadMore=function(){view.renderNextPage(_listOfHorizontalLists,_removeHorizontalScrollListener);_addEventListenerToAllHorizontalLists()};this.toString=function(){console.log("model:");console.log(_model);console.log("view:");console.log(_view)}};var KK=KK||{};KK.View=function(){var _mainContainer=document.querySelector("#mainContainer");var _header=document.querySelector("#header");var _vil;this.createVerticalInfiniteList=function(listOfHorizontalLists){_vil=new KK.UiComponents.VerticalInfiniteList({data:listOfHorizontalLists,pageSize:5,className:"h-list",targetEle:_mainContainer,maxNodes:50})};this.addHorizonalList=function(obj){if(typeof obj==="undefined"||typeof obj.category==="undefined"||typeof obj.moviesList==="undefined")return;var _newHList=new KK.UiComponents.HorizontalList({category:obj.category,moviesList:obj.moviesList,getMoviePic:obj.getMoviePic});return _newHList};this.updateVerticalInfiniteList=function(listOfHorizontalLists){_vil.updateList(listOfHorizontalLists)};this.loadAllImages=function(ele,postLoadedFn){var _postLoadedFn=postLoadedFn;var list=ele.getElementsByClassName("h-ele");if(list[list.length-1].style.background.indexOf("url(")>=0){_postLoadedFn(ele.lastElementChild);return}for(var i=0;i<list.length;i++){if(list[i].style.background.indexOf("url(")<0){list[i].style.background=list[i].title;list[i].style.backgroundColor="black";list[i].style.backgroundSize="125px 180px";list[i].style.backgroundRepeat="no-repeat"}}_postLoadedFn(ele.lastElementChild)};this.render=function(list){_vil.renderNextPage(list)};this.renderNextPage=function(list,postCleanUpCallback){_vil.renderNextPage(list,postCleanUpCallback)};this.selectElement=function(ele){if(typeof ele!=="undefined"){ele.className="h-ele h-ele-selected"}};this.unselectElement=function(ele){if(typeof ele!=="undefined"){ele.className="h-ele"}};this.getMainContainer=function(){return _mainContainer};this.toString=function(){console.log("mainContainer:");console.log(_mainContainer);console.log("listOfHorizontalLists:");console.log(_listOfHorizontalLists)}};var KK=KK||{};KK.ViewMovieDetails=function(){var _mainContainer=null;var _BASE_CLASS="movie-details-container";var _HIDE_CLASS="page-move-to-left";var _SHOW_CLASS="page-move-from-left";var _getMainContainerInstance=function(){_mainContainer=document.getElementById("movieDetailsContainer");if(_mainContainer===null){_mainContainer=_createFromTemplate()}return _mainContainer};var _createFromTemplate=function(){var template=document.querySelector("#movieDetailsTemplate");if(template===null)return;return document.body.appendChild(document.importNode(template.content,true))};this.render=function(contentObj){var _container=_getMainContainerInstance();if(typeof contentObj!=="undefined"&&typeof contentObj.title!=="undefined"&&typeof contentObj.pic!=="undefined"){var _ele=document.getElementById("movieDetailsPic");_ele.style.background="url('assets/play-button-overlay.png'), url('"+contentObj.pic+"')";_ele.style.backgroundColor="transparent, black";_ele.style.backgroundSize="124px 124px, 125px 180px";_ele.style.backgroundRepeat="no-repeat, no-repeat";_ele.style.backgroundPosition="center center, center center";document.getElementById("movieDetailsTitle").innerText=contentObj.title}_container.className=_BASE_CLASS+" "+_SHOW_CLASS;if(typeof contentObj.callback==="function")contentObj.callback()};this.hide=function(){_getMainContainerInstance().className=_BASE_CLASS+" "+_HIDE_CLASS}};KK.ViewMovieDetails.prototype=new KK.View;KK.ViewMovieDetails.constructor=KK.ViewMovieDetails;var KK=KK||{};var init=function(){var model=new KK.Model;var view=new KK.View(model);var controller=new KK.Controller(model,view);controller.init()}();